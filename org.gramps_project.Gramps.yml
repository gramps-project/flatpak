app-id: org.gramps_project.Gramps
# flatpak-builder will not take com.gramps-project.Gramps
runtime: org.gnome.Platform
runtime-version: '3.38'
sdk: org.gnome.Sdk
command: gramps
rename-icon: gramps
finish-args:
# for error notifications
  - --socket=pulseaudio
# Gramps installs media files from backups to home, so it needs home access for now
#  - --filesystem=xdg-documents
#  - --filesystem=xdg-download
#  - --filesystem=xdg-pictures
#  - --filesystem=~/.gramps:create
  - --filesystem=home
# needs to own upstream name
  - --own-name=org.gramps-project.Gramps
# for gui
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
#needs network access for maps
  - --share=network
modules:
# GNU Revision Control System, current 202104
  - name: RCSDependency
    buildsystem: autotools
    sources:
      - type: archive
        url:  http://mirror.keystealth.org/gnu/rcs/rcs-5.10.0.tar.xz
        sha256:  3a0d9f958c7ad303e475e8634654974edbe6deb3a454491f3857dc1889bac5c5

# PILLOW for cropping images, latex support, and addons; current 202104
  - name: PILLOWDependency
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url:  https://files.pythonhosted.org/packages/21/23/af6bac2a601be6670064a817273d4190b79df6f74d8012926a39bc7aa77f/Pillow-8.2.0.tar.gz
        sha256:  a787ab10d7bb5494e5f76536ac460741788f1fbce851068d73a87ca7c35fc3e1

# following dependencies are for the GraphView Addon
    # pgi is not maintained as of 2018, github suggests using pygobject instead
  - name: PGIDependency
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url:  https://github.com/pygobject/pgi/archive/0.0.11.2.tar.gz
        sha256:  7a1ca8ac4e8bee6b663e6d556ecda8032584de753acd76ab3fc21c4f874fa738

    # most recent for gnome 3.38 as of 202104
  - name: PygobjectDependency
    buildsystem: meson
    config-opts:
      - --prefix=/app
    sources:
      - type: archive
        url:  https://download-fallback.gnome.org/sources/pygobject/3.38/pygobject-3.38.0.tar.xz
        sha256:  0372d1bb9122fc19f500a249b1f38c2bb67485000f5887497b4b205b3e7084d5

    # Goocanvas 3 does not work with GraphView as of 202104
  - name: GoocanvasDependency
    buildsystem: autotools
    config-opts:
      - --prefix=/app
    make-install-args:
      - pyoverridesdir=/app/lib/python3.8/site-packages/gi/overrides
      - typelibdir=/app/lib/girepository-1.0
    sources:
      - type: archive
        url:  https://download.gnome.org/sources/goocanvas/2.0/goocanvas-2.0.4.tar.xz
        sha256:  c728e2b7d4425ae81b54e1e07a3d3c8a4bd6377a63cffa43006045bceaa92e90

# gramps does not seem to recognize enchant2 included with sdk or platform
# following dependencies are for spell check   
  # current as of 202104
  - name: enchant2
    buildsystem: autotools
    config-opts:
      - --prefix=/app
    sources:
      - type: archive
        url:  https://github.com/AbiWord/enchant/archive/refs/tags/v2.2.15.tar.gz
        sha256:  85295934102a4ab94f209cbc7c956affcb2834e7a5fb2101e2db436365e2922d

#  - name: enchant-ver1
#    buildsystem: autotools
#    sources:
#      - type: archive
#        url: https://github.com/AbiWord/enchant/releases/download/enchant-1-6-1/enchant-1.6.1.tar.gz
#        sha256: bef0d9c0fef2e4e8746956b68e4d6c6641f6b85bd2908d91731efb68eba9e3f5

  - name: intltool
    buildsystem: autotools
    sources:
      - type: archive
        url: https://launchpad.net/intltool/trunk/0.51.0/+download/intltool-0.51.0.tar.gz
        sha256: 67c74d94196b153b774ab9f89b2fa6c6ba79352407037c8c14d5aeb334e959cd

  - name: gtk-spell
    buildsystem: autotools
    sources:
      - type: archive
        url: https://sourceforge.net/projects/gtkspell/files/3.0.10/gtkspell3-3.0.10.tar.xz
        sha256: b040f63836b347eb344f5542443dc254621805072f7141d49c067ecb5a375732

# following dependencies are for the old Berkeley database
  - name: BSDDB3
    subdir: dist
    builddir: true
    config-opts:
      - --enable-compat185
      - --enable-shared
      - --enable-cxx
      - --enable-dbm
      - --enable-stl
    sources:
      - type: archive
        url: https://download.oracle.com/berkeley-db/db-5.3.28.tar.gz
        sha256: e0a992d740709892e81f9d93f06daf305cf73fb81b545afe72478043172c3628
      - type: patch
        path: atomic.patch
        # for aarch64 
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} dist

  - name: python3-bsddb
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-options:
      env:
        BERKELEYDB_DIR: /app
    build-commands:
      - python3 setup.py build
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/b/bsddb3/bsddb3-6.2.7.tar.gz
        sha256: b0f7fa63eb240cd5815809c9d1d7df9f7cc8d6fa9619d0edbe9c794afc02dc9f

# following dependencies are for images
  - name: exiv2Dependency
    buildsystem: cmake
    sources:
      - type: archive
        url:  https://www.exiv2.org/builds/exiv2-0.27.3-Source.tar.gz
        sha256:  a79f5613812aa21755d578a297874fb59a85101e793edc64ec2c6bd994e3e778
        # for arm64 compatibility
      - type: patch
        path: exiv2-arch-flags.patch
      - type: patch
        path: exiv2-arch-flags-2.patch

  - name: gexiv2Dependency
    buildsystem: meson
    config-opts:
      - -Dpython3_girdir=/app/lib/python3.8/site-packages/gi/overrides
    sources:
      - type: archive
        url:  https://download.gnome.org/sources/gexiv2/0.12/gexiv2-0.12.1.tar.xz
        sha256:  8aeafd59653ea88f6b78cb03780ee9fd61a2f993070c5f0d0976bed93ac2bd77

# following dependencies are for geography and charts
  - name: python-fontconfig
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url: https://github.com/ldo/python_fontconfig/archive/v0.7.tar.gz
        sha256: 44d3f1597afae0720c02d2504105c5c2b074f2e6bc017f3c73fe33559e571e3b

  - name: osmgpsmapDependency
    buildsystem: autotools
    sources:
       - type: archive
         url:  https://github.com/nzjrs/osm-gps-map/releases/download/1.1.0/osm-gps-map-1.1.0.tar.gz
         sha256:  8f2ff865ed9ed9786cc5373c37b341b876958416139d0065ebb785cf88d33586

  # Gramps does not see geocodeglib in platform, needed for place coordinate addon
  - name: geocodeglibDependency
    buildsystem: meson
    sources:
      - type: archive
        url:  https://gitlab.gnome.org/GNOME/geocode-glib/-/archive/master/geocode-glib-master.tar.gz
        sha256:  46b961cee110b4175a62ef599bd3e590e7ef1e86a345de4e0c04ab74146eddbe

  - name: PyICUDependency
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url:  https://files.pythonhosted.org/packages/31/46/fa08c8efae2951e67681ec24319f789fc1a74e2096dd74373e34c79319de/PyICU-2.6.tar.gz
        sha256:  a9a5bf6833360f8f69e9375b91c1a7dd6e0c9157a42aee5bb7d6891804d96371

  - name: GraphVizDependency
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www2.graphviz.org/Packages/stable/portable_source/graphviz-2.44.0.tar.gz
        sha256:  9aabd13a8018b708ab3c822de2326c19d0a52ed59f50a6b0f9318c07e2a6d93b

  - name: GhostscriptDependency
    buildsystem: autotools
    sources:
      - type: archive
        url:  https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9533/ghostscript-9.53.3.tar.gz
        sha256:  6eaf422f26a81854a230b80fd18aaef7e8d94d661485bd2e97e695b9dce7bf7f

# for network chart addon
  - name: decoratorDependency
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url:  https://files.pythonhosted.org/packages/da/93/84fa12f2dc341f8cf5f022ee09e109961055749df2d0c75c5f98746cfe6c/decorator-4.4.2.tar.gz
        sha256:  e3a62f0520172440ca0dcc823749319382e377f37f140a0b99ef45fecb84bfe7

  - name: networkxDependency
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url:  https://files.pythonhosted.org/packages/ef/d0/f706a9e5814a42c544fa1b2876fc33e5d17e1f2c92a5361776632c4f41ab/networkx-2.5.tar.gz
        sha256:  7978955423fbc9639c10498878be59caf99b44dc304c2286162fd24b458c1602

  - name: pyGraphvizDependency
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=/app
    sources:
      - type: archive
        url:  https://files.pythonhosted.org/packages/3a/d6/2c56f09ee83dbebb62c40487e4c972135661b9984fec9b30b77fb497090c/pygraphviz-1.7.zip
        sha256:  a7bec6609f37cf1e64898c59f075afd659106cf9356c5f387cecaa2e0cdb2304

# Gramps
  - name: Gramps
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=/app --exec-prefix=/bin
      - install -Dm644 /app/share/icons/gramps.png -t /app/share/icons/hicolor/48x48/apps/
      - install -Dm644 /app/share/gramps/images/gramps.svg -t /app/share/icons/hicolor/scalable/apps/
      - install -Dm644 org.gramps_project.Gramps.desktop -t /app/share/applications/
      - install -Dm644 org.gramps_project.Gramps.metainfo.xml -t /app/share/metainfo/
    sources:
      - type: archive
        url:  https://github.com/gramps-project/gramps/archive/v5.1.3.tar.gz
        sha256:  91d755b7e407af40ce5ebe24b29baab860bc6e2871ebcbee3f5e109c438df1e8
      - type: file
        path:  org.gramps_project.Gramps.desktop
      - type: file
        path:  org.gramps_project.Gramps.metainfo.xml
